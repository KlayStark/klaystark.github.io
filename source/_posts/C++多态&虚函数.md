---
title: C++多态&虚函数
date: 2021-06-27 15:40:08
categories: C++
tags:
---
## 名词解释

**多态**：同一个函数名具有多种状态，或者说一个接口具有不同行为。C++的多态分为编译时多态和运行时多态，编译时多态也称为为静态联编，通过**函数重载和模板**来实现，运行时多态称为动态联编，通过**继承和虚函数**来实现。

**虚函数**：虚函数是在基类中使用关键字 virtual 声明的函数。在派生类中重新定义基类中定义的虚函数时，会告诉编译器不要静态链接到该函数。

## 形成多态的三个条件

1. 必须存在继承关系；

2. 继承关系必须有同名虚函数；

3. 存在基类类型的指针或者引用，通过该指针或引用调用虚函数。

## 虚函数的实现机制（原理）

虚函数是通过虚函数表来实现的。

虚函数表包含了一个类(所有)的虚函数的地址，在有虚函数的类对象中，它内存空间的头部会有一个虚函数表指针(虚表指针)，用来管理虚函数表。当子类对象对父类虚函数进行重写的时候，虚函数表的相应虚函数地址会发生改变，改写成这个虚函数的地址，当我们用一个父类的指针来操作子类对象的时候，它可以指明实际所调用的函数。

---

### 虚函数调用是在编译时确定还是运行时确定的？如何确定调用哪个函数？
运行时确定；通过查找虚函数表中的函数地址确定。

---

### 虚函数是存在类中还是类对象中（即是否共享虚表）？
存在类中，不同的类对象共享一张虚函数表(为了节省内存空间)。

---

### 为什么构造函数不能为虚函数？
构造函数的一个重要使命，就是记录虚函数表。虚函数的调用需要虚函数表指针，而该指针存放在对象的内容空间中；若构造函数声明为虚函数，那么由于对象还未创建，还没有内存空间，更没有虚函数表地址用来调用虚函数——构造函数了。

### 为什么析构函数可以为虚函数？
析构函数可以为虚函数，而且当要使用基类指针或引用调用子类时，最好将基类的析构函数声明为虚函数，否则可能存在内存泄露的问题。

举例：

子类B继承自基类A；`A *p = new B; delete p;`

1. 此时，如果类A的析构函数不是虚函数，那么**delete p；将会仅仅调用A的析构函数**，只释放了B对象中的A部分，而派生出的新的部分未释放掉。

2. 如果类A的析构函数是虚函数，delete p; 将会先调用B的析构函数，再调用A的析构函数，释放B对象的所有空间。
    
补充： B *p = new B; delete p;时也是先调用B的析构函数，再调用A的析构函数。


## 纯虚函数

即Java中的接口。



在基类中声明的虚函数，它在基类中没有定义，但要求任何派生类都要定义自己的实现方法。
`virtual void funtion1() = 0`

带有纯虚函数的类为抽象类，它不能生成对象。